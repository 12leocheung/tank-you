<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TANK ROYALE</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
<style>
:root{--g:#39ff14;--ga:rgba(57,255,20,0.18);--a:#ffb800;--r:#ff3a3a;--c:#00e5ff;--bg:#060c07;--border:rgba(57,255,20,0.2)}
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden}
body{background:var(--bg);display:flex;justify-content:center;align-items:center;font-family:'Share Tech Mono',monospace;cursor:none}
#gc{position:relative}
canvas{display:block}
#ui{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
#gc::after{content:'';position:absolute;inset:0;pointer-events:none;z-index:10000;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.1) 3px,rgba(0,0,0,0.1) 4px)}
#hud{position:absolute;top:18px;left:18px;color:var(--g);font-size:12px;letter-spacing:2px}
#hud .label{color:rgba(57,255,20,0.4);font-size:9px;letter-spacing:3px;margin-bottom:3px}
#aliveCount{font-family:'Orbitron',sans-serif;font-size:14px;letter-spacing:3px;color:var(--g);margin-bottom:12px;text-shadow:0 0 12px var(--g),0 0 24px rgba(57,255,20,0.3)}
#barWrap{width:230px;height:8px;background:rgba(57,255,20,0.07);border:1px solid rgba(57,255,20,0.2);margin-bottom:10px}
#hpFill{height:100%;background:var(--g);transition:width .15s;box-shadow:0 0 8px var(--g),0 0 18px rgba(57,255,20,0.4)}
#xpBarWrap{width:230px;height:3px;background:rgba(255,184,0,0.07);border:1px solid rgba(255,184,0,0.15);margin-bottom:5px}
#xpFill{height:100%;background:var(--a);transition:width .3s;box-shadow:0 0 6px var(--a)}
#classTag{font-size:11px;letter-spacing:3px;color:rgba(57,255,20,0.7);margin-bottom:6px}
#ammoBar{display:flex;align-items:center;gap:3px;margin-top:5px}
.ammoPip{width:7px;height:14px;background:var(--g);box-shadow:0 0 5px var(--g)}
.ammoPip.empty{background:rgba(57,255,20,0.1);box-shadow:none;border:1px solid rgba(57,255,20,0.12)}
#minimap{position:absolute;bottom:18px;right:18px;border:1px solid var(--border);background:rgba(3,7,3,0.93);box-shadow:0 0 16px rgba(57,255,20,0.1)}
#minimapLabel{position:absolute;bottom:194px;right:18px;font-size:8px;letter-spacing:3px;color:rgba(57,255,20,0.25)}
#kf{position:absolute;top:18px;right:18px;text-align:right;font-size:10px;letter-spacing:1px;max-width:300px}
.ke{color:rgba(57,255,20,0.6);margin:2px 0;background:rgba(0,0,0,0.6);padding:2px 8px;border-right:2px solid var(--g);transition:opacity .8s}
.ke.kp{color:var(--a);border-right-color:var(--a)}
#zoneInfo{position:absolute;top:18px;left:50%;transform:translateX(-50%);color:var(--r);font-size:10px;letter-spacing:4px;text-align:center;text-shadow:0 0 12px var(--r);animation:zp 1s infinite}
@keyframes zp{0%,100%{opacity:1}50%{opacity:0.5}}
#upgradePanel{position:absolute;bottom:80px;left:50%;transform:translateX(-50%);display:none;pointer-events:all;background:rgba(3,9,3,0.97);border:1px solid var(--border);padding:20px 28px;min-width:560px;box-shadow:0 0 40px rgba(57,255,20,0.12)}
#upgradePanel h3{letter-spacing:5px;font-size:11px;color:var(--g);margin-bottom:16px;text-align:center;font-family:'Orbitron',sans-serif;text-shadow:0 0 10px var(--g)}
#upgradeBtns{display:flex;gap:12px;justify-content:center}
.upBtn{background:rgba(57,255,20,0.03);border:1px solid rgba(57,255,20,0.18);color:rgba(57,255,20,0.55);font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:1px;padding:14px 16px;cursor:pointer;transition:all .15s;width:158px;text-align:left}
.upBtn:hover{border-color:var(--g);color:var(--g);background:rgba(57,255,20,0.07);box-shadow:0 0 18px rgba(57,255,20,0.18)}
.upBtn .upName{font-family:'Orbitron',sans-serif;font-size:10px;color:var(--g);margin-bottom:6px;letter-spacing:2px}
.upBtn .upDesc{font-size:9px;color:rgba(57,255,20,0.38);letter-spacing:1px;line-height:1.7}
.upBtn .upLvl{font-size:8px;color:rgba(57,255,20,0.22);margin-top:5px}
#menu,#deathScreen,#winScreen,#classScreen,#lobbyScreen,#onlineScreen{position:absolute;top:0;left:0;width:100%;height:100%;background:var(--bg);display:flex;flex-direction:column;justify-content:center;align-items:center;color:var(--g);pointer-events:all}
#menu h1{font-family:'Orbitron',sans-serif;font-weight:900;font-size:62px;letter-spacing:12px;margin-bottom:3px;color:var(--g);text-shadow:0 0 20px var(--g),0 0 60px rgba(57,255,20,0.35),0 0 100px rgba(57,255,20,0.12);animation:tg 3s ease-in-out infinite}
@keyframes tg{0%,100%{text-shadow:0 0 20px var(--g),0 0 60px rgba(57,255,20,0.35),0 0 100px rgba(57,255,20,0.12)}50%{text-shadow:0 0 30px var(--g),0 0 80px rgba(57,255,20,0.55),0 0 140px rgba(57,255,20,0.22)}}
#menu .sub{letter-spacing:9px;font-size:11px;color:rgba(57,255,20,0.3);margin-bottom:26px}
#statsRow{font-size:10px;letter-spacing:2px;color:rgba(57,255,20,0.28);margin-bottom:8px}
#rankCard{text-align:center;margin-bottom:26px;padding:18px 40px;border:1px solid var(--border);background:rgba(57,255,20,0.025);min-width:300px;box-shadow:0 0 22px rgba(57,255,20,0.07)}
#rankTierLabel{font-family:'Orbitron',sans-serif;font-size:26px;letter-spacing:6px;font-weight:900;margin-bottom:3px}
#rankRpLabel{font-size:10px;letter-spacing:3px;color:rgba(57,255,20,0.32);margin-bottom:12px}
#rankBarOuter{width:100%;height:4px;background:rgba(57,255,20,0.07);overflow:hidden;margin-bottom:5px}
#rankBarFill{height:100%;background:var(--g);transition:width .5s;box-shadow:0 0 8px var(--g)}
#rankBarSub{font-size:8px;letter-spacing:2px;color:rgba(57,255,20,0.25)}
.menuBtn{background:rgba(57,255,20,0.025);border:1px solid rgba(57,255,20,0.2);color:rgba(57,255,20,0.5);font-family:'Share Tech Mono',monospace;font-size:13px;letter-spacing:4px;padding:12px 40px;margin:5px;cursor:pointer;transition:all .18s;position:relative;overflow:hidden}
.menuBtn::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(57,255,20,0.06),transparent);transform:translateX(-100%);transition:transform .4s}
.menuBtn:hover::before{transform:translateX(100%)}
.menuBtn:hover{border-color:var(--g);color:var(--g);box-shadow:0 0 20px rgba(57,255,20,0.18)}
.menuBtn.primary{border-color:rgba(57,255,20,0.45);color:var(--g)}
.menuBtn.danger{border-color:rgba(255,58,58,0.22);color:rgba(255,58,58,0.4)}
.menuBtn.danger:hover{border-color:var(--r);color:var(--r);box-shadow:0 0 16px rgba(255,58,58,0.18)}
#deathScreen h2{font-family:'Orbitron',sans-serif;font-size:52px;letter-spacing:8px;margin-bottom:10px;color:var(--r);text-shadow:0 0 20px var(--r),0 0 50px rgba(255,58,58,0.28)}
#winScreen h2{font-family:'Orbitron',sans-serif;font-size:52px;letter-spacing:8px;margin-bottom:10px;color:var(--g);text-shadow:0 0 20px var(--g),0 0 60px rgba(57,255,20,0.38)}
#endStats,#endStats2{font-size:11px;letter-spacing:2px;color:rgba(57,255,20,0.38);margin-bottom:18px;text-align:center;line-height:2.4}
#classScreen h2{font-family:'Orbitron',sans-serif;font-size:28px;letter-spacing:8px;margin-bottom:3px;text-shadow:0 0 14px var(--g)}
#classScreen .sub{color:rgba(57,255,20,0.28);letter-spacing:4px;font-size:10px;margin-bottom:28px}
#classGrid{display:flex;gap:14px;margin-bottom:26px}
.classCard{border:1px solid rgba(57,255,20,0.13);padding:18px 14px;width:150px;cursor:pointer;transition:all .2s;text-align:center;background:rgba(57,255,20,0.018)}
.classCard:hover{border-color:rgba(57,255,20,0.45);background:rgba(57,255,20,0.045);box-shadow:0 0 16px rgba(57,255,20,0.1)}
.classCard.selected{border-color:var(--g);background:rgba(57,255,20,0.065);box-shadow:0 0 26px rgba(57,255,20,0.22)}
.classCard .cname{font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:3px;margin-bottom:8px;color:var(--g)}
.classCard .cicon{font-size:30px;margin-bottom:10px}
.classCard .cstat{font-size:8px;color:rgba(57,255,20,0.38);letter-spacing:1px;line-height:1.9;text-align:left}
.classCard .cbadge{font-size:7px;color:rgba(255,184,0,0.45);letter-spacing:1px;margin-top:7px;border-top:1px solid rgba(57,255,20,0.08);padding-top:7px}
#rankBadge{position:absolute;bottom:18px;left:18px;font-size:9px;letter-spacing:2px;color:rgba(57,255,20,0.38);border:1px solid rgba(57,255,20,0.13);padding:5px 12px;background:rgba(0,0,0,0.6)}
.xpFloat{position:absolute;font-size:12px;letter-spacing:2px;color:var(--g);pointer-events:none;animation:xr .9s forwards;font-family:'Share Tech Mono',monospace;text-shadow:0 0 8px var(--g)}
@keyframes xr{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-50px)}}
#menuCvs{position:absolute;top:0;left:0;pointer-events:none;z-index:9999}
#lobbyScreen h2{font-family:'Orbitron',sans-serif;font-size:28px;letter-spacing:8px;margin-bottom:4px;text-shadow:0 0 14px var(--g)}
#lobbyScreen .sub{color:rgba(57,255,20,0.28);font-size:10px;letter-spacing:4px;margin-bottom:22px}
#lobbyCode{font-family:'Orbitron',sans-serif;font-size:52px;letter-spacing:14px;font-weight:900;color:var(--g);margin-bottom:6px;text-shadow:0 0 20px var(--g)}
#lobbyCodeLabel{font-size:9px;letter-spacing:3px;color:rgba(57,255,20,0.28);margin-bottom:22px;cursor:pointer}
#lobbyCodeLabel:hover{color:var(--g)}
#countdownWrap{text-align:center;margin-bottom:16px}
#countdown{font-family:'Orbitron',sans-serif;font-size:42px;letter-spacing:5px;color:var(--g);text-shadow:0 0 20px var(--g),0 0 40px rgba(57,255,20,0.3);line-height:1}
#countdown.urgent{color:var(--r);text-shadow:0 0 20px var(--r),0 0 40px rgba(255,58,58,0.3);animation:zp 0.5s infinite}
#countdownLabel{font-size:8px;letter-spacing:4px;color:rgba(57,255,20,0.25);margin:4px 0 8px}
#countdownBar{width:320px;height:3px;background:rgba(57,255,20,0.08);border:1px solid rgba(57,255,20,0.12);margin:0 auto}
#countdownFill{height:100%;background:var(--g);width:100%;transition:width 1s linear;box-shadow:0 0 8px var(--g)}
#countdownFill.urgent{background:var(--r);box-shadow:0 0 8px var(--r)}
#lobbyListHeader{display:flex;justify-content:space-between;align-items:center;width:360px;margin-bottom:6px;font-size:8px;letter-spacing:3px;color:rgba(57,255,20,0.28);padding:0 2px}
#playerList{display:flex;flex-direction:column;gap:4px;margin-bottom:16px;min-height:80px;width:360px;max-height:260px;overflow-y:auto}
.playerEntry{font-size:10px;letter-spacing:2px;border:1px solid rgba(57,255,20,0.13);padding:7px 12px;display:flex;justify-content:space-between;align-items:center;background:rgba(57,255,20,0.018);animation:fadeSlide .25s ease}
@keyframes fadeSlide{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.playerEntry .pname{color:rgba(57,255,20,0.85);display:flex;align-items:center;gap:6px}
.playerEntry .pname .picon{font-size:14px}
.playerEntry .pright{display:flex;gap:10px;align-items:center}
.playerEntry .pclass{color:rgba(57,255,20,0.38);font-size:8px;letter-spacing:3px}
.playerEntry .phost{font-size:7px;letter-spacing:2px;color:var(--a);border:1px solid rgba(255,184,0,0.3);padding:1px 5px}
.playerEntry.isBot{opacity:0.22;border-style:dashed}
.playerEntry.isSelf{border-color:rgba(57,255,20,0.4);background:rgba(57,255,20,0.04)}
#joinInput{background:rgba(57,255,20,0.035);border:1px solid rgba(57,255,20,0.22);color:var(--g);font-family:'Orbitron',sans-serif;font-size:22px;letter-spacing:8px;padding:10px 18px;text-align:center;text-transform:uppercase;width:200px;margin-bottom:8px}
#joinInput:focus{outline:none;border-color:var(--g);box-shadow:0 0 16px rgba(57,255,20,0.18)}
#joinInput::placeholder{color:rgba(57,255,20,0.16);font-size:14px;letter-spacing:4px}
#lobbyStatus{font-size:10px;letter-spacing:2px;color:rgba(57,255,20,0.32);min-height:18px;margin-bottom:10px}
.divider{width:220px;height:1px;background:rgba(57,255,20,0.08);margin:12px 0}
#mqttStatus{position:absolute;bottom:40px;left:50%;transform:translateX(-50%);font-size:8px;letter-spacing:3px;color:rgba(57,255,20,0.18)}
#joinStatus{font-size:10px;letter-spacing:2px;color:rgba(57,255,20,0.38);height:16px;margin-bottom:8px}
.rpr{background:rgba(3,9,3,0.97);border:1px solid rgba(57,255,20,0.18);padding:18px 30px;text-align:center;min-width:330px;margin-bottom:18px;box-shadow:0 0 24px rgba(57,255,20,0.08)}
.rpTitle{font-size:9px;letter-spacing:5px;color:rgba(57,255,20,0.28);margin-bottom:10px;font-family:'Orbitron',sans-serif}
.rpRows{font-size:10px;letter-spacing:2px;color:rgba(57,255,20,0.38);line-height:2.2}
.rpChange{font-family:'Orbitron',sans-serif;font-size:24px;letter-spacing:4px;font-weight:900;margin-top:8px}
.rpChange.up{color:var(--g);text-shadow:0 0 14px var(--g)}
.rpChange.down{color:rgba(255,58,58,0.7)}
.rpNew{font-size:9px;letter-spacing:3px;margin-top:5px}
.rpBarWrap{width:100%;height:3px;background:rgba(57,255,20,0.07);margin-top:10px}
.rpBarFill{height:100%;background:var(--g);transition:width 1.2s;box-shadow:0 0 8px var(--g)}
#onlineScreen{position:absolute;top:0;left:0;width:100%;height:100%;background:var(--bg);display:none;flex-direction:column;justify-content:center;align-items:center;color:var(--g);pointer-events:all}
#onlineScreen h2{font-family:'Orbitron',sans-serif;font-size:28px;letter-spacing:8px;margin-bottom:5px;text-shadow:0 0 14px var(--g)}
#bgCvs{position:absolute;top:0;left:0;pointer-events:none;z-index:0;opacity:0.4}
.ctl,.ctr,.cbl,.cbr{position:absolute;width:22px;height:22px;pointer-events:none}
.ctl{top:14px;left:14px;border-top:1px solid rgba(57,255,20,0.4);border-left:1px solid rgba(57,255,20,0.4)}
.ctr{top:14px;right:14px;border-top:1px solid rgba(57,255,20,0.4);border-right:1px solid rgba(57,255,20,0.4)}
.cbl{bottom:14px;left:14px;border-bottom:1px solid rgba(57,255,20,0.4);border-left:1px solid rgba(57,255,20,0.4)}
.cbr{bottom:14px;right:14px;border-bottom:1px solid rgba(57,255,20,0.4);border-right:1px solid rgba(57,255,20,0.4)}
#controlHint{position:absolute;bottom:18px;left:50%;transform:translateX(-50%);font-size:8px;letter-spacing:3px;color:rgba(57,255,20,0.18);white-space:nowrap}
</style>
</head>
<body>
<div id="gc">
  <canvas id="bgCvs"></canvas>
  <canvas id="gameCanvas"></canvas>
  <div id="ui">
    <div id="hud">
      <div id="aliveCount">◈ 20 ALIVE</div>
      <div class="label">HULL INTEGRITY</div>
      <div id="barWrap"><div id="hpFill" style="width:100%"></div></div>
      <div id="classTag">WARRIOR ◉</div>
      <div class="label">EXP · <span id="lvlLabel">LV 1</span></div>
      <div id="xpBarWrap"><div id="xpFill" style="width:0%"></div></div>
      <div id="ammoBar"></div>
    </div>
    <div id="zoneInfo"></div>
    <div id="minimapLabel">RADAR</div>
    <canvas id="minimap" width="168" height="168"></canvas>
    <div id="kf"></div>
    <div id="rankBadge">UNRANKED</div>
    <div id="upgradePanel">
      <h3>▲ LEVEL UP — CHOOSE UPGRADE</h3>
      <div id="upgradeBtns"></div>
    </div>
    <div id="deathScreen" style="display:none">
      <div class="ctl"></div><div class="ctr"></div><div class="cbl"></div><div class="cbr"></div>
      <h2>DESTROYED</h2>
      <div id="endStats"></div>
      <div id="rpResult" class="rpr"></div>
      <button class="menuBtn" onclick="showMenu()">MAIN MENU</button>
      <button class="menuBtn primary" onclick="quickRestart()">PLAY AGAIN</button>
    </div>
    <div id="winScreen" style="display:none">
      <div class="ctl"></div><div class="ctr"></div><div class="cbl"></div><div class="cbr"></div>
      <h2>VICTORY</h2>
      <div id="endStats2"></div>
      <div id="rpResult2" class="rpr"></div>
      <button class="menuBtn" onclick="showMenu()">MAIN MENU</button>
      <button class="menuBtn primary" onclick="quickRestart()">PLAY AGAIN</button>
    </div>
  </div>
  <canvas id="menuCvs"></canvas>

  <div id="menu">
    <div class="ctl"></div><div class="ctr"></div><div class="cbl"></div><div class="cbr"></div>
    <h1>TANK ROYALE</h1>
    <div class="sub">LAST TANK STANDING</div>
    <div id="rankCard">
      <div id="rankTierLabel">BRONZE III</div>
      <div id="rankRpLabel">0 RP</div>
      <div id="rankBarOuter"><div id="rankBarFill" style="width:0%"></div></div>
      <div id="rankBarSub"></div>
    </div>
    <div id="statsRow"></div>
    <button class="menuBtn primary" onclick="showClassSelect('bot')">► BOT MATCH</button>
    <button class="menuBtn" onclick="showOnlineOptions()">◈ RANKED ONLINE</button>
    <div id="controlHint">WASD · MOUSE AIM · LMB FIRE · SPACE ABILITY</div>
  </div>

  <div id="onlineScreen">
    <div class="ctl"></div><div class="ctr"></div><div class="cbl"></div><div class="cbr"></div>
    <h2>ONLINE MODE</h2>
    <div style="color:rgba(57,255,20,0.26);font-size:10px;letter-spacing:4px;margin-bottom:30px;">CREATE OR JOIN A LOBBY</div>
    <button class="menuBtn primary" onclick="showClassSelect('online_create')">► CREATE LOBBY</button>
    <div class="divider"></div>
    <div style="color:rgba(57,255,20,0.28);font-size:9px;letter-spacing:3px;margin-bottom:10px;">JOIN WITH CODE</div>
    <input id="joinInput" type="text" maxlength="4" placeholder="XXXX" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')">
    <div id="joinStatus"></div>
    <button class="menuBtn" onclick="doJoinLobby()">JOIN →</button>
    <button class="menuBtn danger" onclick="showMenu()" style="margin-top:10px;font-size:10px;padding:7px 22px;">← BACK</button>
    <div id="mqttStatus">CONNECTING...</div>
  </div>

  <div id="lobbyScreen" style="display:none">
    <div class="ctl"></div><div class="ctr"></div><div class="cbl"></div><div class="cbr"></div>
    <h2>LOBBY</h2>
    <div class="sub">SHARE CODE · BOTS FILL EMPTY SLOTS WHEN TIMER ENDS</div>
    <div id="lobbyCode">----</div>
    <div id="lobbyCodeLabel">LOBBY CODE — CLICK TO COPY</div>
    <div id="countdownWrap">
      <div id="countdown">60</div>
      <div id="countdownLabel">SECONDS TO LAUNCH</div>
      <div id="countdownBar"><div id="countdownFill"></div></div>
    </div>
    <div id="lobbyListHeader">
      <span>PLAYERS</span>
      <span id="lobbyCountLabel">0 / 20</span>
    </div>
    <div id="playerList"></div>
    <div id="lobbyStatus"></div>
    <button class="menuBtn danger" onclick="leaveLobby()">LEAVE LOBBY</button>
  </div>

  <div id="classScreen" style="display:none">
    <div class="ctl"></div><div class="ctr"></div><div class="cbl"></div><div class="cbr"></div>
    <h2>SELECT CLASS</h2>
    <div class="sub">CHOOSE YOUR TANK</div>
    <div id="classGrid"></div>
    <button class="menuBtn primary" onclick="confirmClass()">DEPLOY →</button>
    <button class="menuBtn" onclick="goBackFromClass()" style="font-size:10px;padding:7px 22px;margin-top:4px;">← BACK</button>
  </div>
</div>

<script>
'use strict';

// ── AUDIO ──────────────────────────────────────────────
const AC=new(window.AudioContext||window.webkitAudioContext)();
function nbuf(d){const s=AC.sampleRate,b=AC.createBuffer(1,Math.ceil(s*d),s),dd=b.getChannelData(0);for(let i=0;i<dd.length;i++)dd[i]=Math.random()*2-1;return b;}
function playShot(pm=1){
  if(AC.state==='suspended')AC.resume();const t=AC.currentTime;
  const comp=AC.createDynamicsCompressor();comp.threshold.value=-3;comp.knee.value=3;comp.ratio.value=20;comp.attack.value=0.001;comp.release.value=0.15;comp.connect(AC.destination);
  const master=AC.createGain();master.gain.value=1.4;master.connect(comp);
  const F=fn=>{try{fn();}catch(e){}};
  F(()=>{const o=AC.createOscillator();o.type='sine';o.frequency.setValueAtTime(85/pm,t);o.frequency.exponentialRampToValueAtTime(28/pm,t+0.25);const g=AC.createGain();g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(4.5,t+0.004);g.gain.exponentialRampToValueAtTime(2.8,t+0.03);g.gain.exponentialRampToValueAtTime(0.001,t+0.55);o.connect(g);g.connect(master);o.start(t);o.stop(t+0.6);});
  F(()=>{const o=AC.createOscillator();o.type='sine';o.frequency.setValueAtTime(42/pm,t);o.frequency.exponentialRampToValueAtTime(18/pm,t+0.4);const g=AC.createGain();g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(3.5,t+0.006);g.gain.exponentialRampToValueAtTime(0.001,t+0.7);const lp=AC.createBiquadFilter();lp.type='lowpass';lp.frequency.value=120;o.connect(lp);lp.connect(g);g.connect(master);o.start(t);o.stop(t+0.75);});
  F(()=>{const s=AC.createBufferSource();s.buffer=nbuf(0.04);const hp=AC.createBiquadFilter();hp.type='highpass';hp.frequency.value=1800*pm;const dist=AC.createWaveShaper();const cv=new Float32Array(512);for(let i=0;i<512;i++){const x=(i*2)/512-1;cv[i]=x<0?-Math.pow(Math.abs(x),0.5):Math.pow(x,0.5);}dist.curve=cv;const g=AC.createGain();g.gain.setValueAtTime(6,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.035);s.connect(hp);hp.connect(dist);dist.connect(g);g.connect(master);s.start(t);s.stop(t+0.05);});
  F(()=>{const s=AC.createBufferSource();s.buffer=nbuf(0.18);const bp=AC.createBiquadFilter();bp.type='bandpass';bp.frequency.setValueAtTime(320*pm,t+0.005);bp.frequency.exponentialRampToValueAtTime(80*pm,t+0.18);bp.Q.value=2.5;const dist=AC.createWaveShaper();const c2=new Float32Array(512);for(let i=0;i<512;i++){const x=(i*2)/512-1;c2[i]=(Math.PI+600)*x/(Math.PI+600*Math.abs(x));}dist.curve=c2;const g=AC.createGain();g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(4.2,t+0.005);g.gain.exponentialRampToValueAtTime(2.5,t+0.02);g.gain.exponentialRampToValueAtTime(0.001,t+0.22);s.connect(bp);bp.connect(dist);dist.connect(g);g.connect(master);s.start(t);s.stop(t+0.25);});
  F(()=>{const s=AC.createBufferSource();s.buffer=nbuf(0.9);const lp=AC.createBiquadFilter();lp.type='lowpass';lp.frequency.setValueAtTime(600/pm,t+0.01);lp.frequency.exponentialRampToValueAtTime(60/pm,t+0.85);lp.Q.value=0.5;const g=AC.createGain();g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(3.8,t+0.012);g.gain.exponentialRampToValueAtTime(1.8,t+0.08);g.gain.exponentialRampToValueAtTime(0.001,t+1.0);s.connect(lp);lp.connect(g);g.connect(master);s.start(t+0.005);s.stop(t+1.05);});
  F(()=>{const s=AC.createBufferSource();s.buffer=nbuf(1.4);const bp=AC.createBiquadFilter();bp.type='bandpass';bp.frequency.setValueAtTime(280/pm,t+0.06);bp.frequency.exponentialRampToValueAtTime(60/pm,t+1.2);bp.Q.value=5;const delay=AC.createDelay(0.5);delay.delayTime.value=0.055;const fb=AC.createGain();fb.gain.value=0.52;const g=AC.createGain();g.gain.setValueAtTime(0,t+0.04);g.gain.linearRampToValueAtTime(1.2,t+0.09);g.gain.exponentialRampToValueAtTime(0.001,t+1.5);s.connect(bp);bp.connect(g);g.connect(delay);delay.connect(fb);fb.connect(delay);g.connect(master);delay.connect(master);s.start(t+0.04);s.stop(t+1.6);});
  F(()=>{const s=AC.createBufferSource();s.buffer=nbuf(0.35);const hp=AC.createBiquadFilter();hp.type='highpass';hp.frequency.setValueAtTime(5000*pm,t);hp.frequency.exponentialRampToValueAtTime(800*pm,t+0.3);const g=AC.createGain();g.gain.setValueAtTime(0.7,t+0.01);g.gain.exponentialRampToValueAtTime(0.001,t+0.38);s.connect(hp);hp.connect(g);g.connect(master);s.start(t+0.01);s.stop(t+0.4);});
  F(()=>{const o=AC.createOscillator();o.type='square';o.frequency.setValueAtTime(380*pm,t+0.03);o.frequency.exponentialRampToValueAtTime(120*pm,t+0.09);const g=AC.createGain();g.gain.setValueAtTime(0,t+0.03);g.gain.linearRampToValueAtTime(1.1,t+0.035);g.gain.exponentialRampToValueAtTime(0.001,t+0.12);o.connect(g);g.connect(master);o.start(t+0.03);o.stop(t+0.13);});
}

// ── CANVAS ─────────────────────────────────────────────
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const miniCvs=document.getElementById('minimap');
const mctx=miniCvs.getContext('2d');
const bgCvs=document.getElementById('bgCvs');
const bgCtx=bgCvs.getContext('2d');
const W=window.innerWidth,H=window.innerHeight;
canvas.width=W;canvas.height=H;bgCvs.width=W;bgCvs.height=H;
document.getElementById('gc').style.cssText=`width:${W}px;height:${H}px`;
const MAP=4000,MINI=168,MAX_P=20;

// Offscreen canvas for static map elements (grid, border) - rendered once
const staticCanvas=document.createElement('canvas');
staticCanvas.width=MAP;staticCanvas.height=MAP;
const sCtx=staticCanvas.getContext('2d');
let staticMapReady=false;

function buildStaticMap(){
  // Ground
  sCtx.fillStyle='#07100a';sCtx.fillRect(0,0,MAP,MAP);
  sCtx.globalAlpha=0.055;
  for(let gx=0;gx<MAP;gx+=200)for(let gy=0;gy<MAP;gy+=200){const v=((gx*7+gy*13)%17)/17;sCtx.fillStyle=v>0.5?'#1a3020':'#0d1a10';sCtx.fillRect(gx,gy,200,200);}
  sCtx.globalAlpha=1;
  sCtx.strokeStyle='rgba(57,255,20,0.035)';sCtx.lineWidth=1;
  for(let x=0;x<=MAP;x+=200){sCtx.beginPath();sCtx.moveTo(x,0);sCtx.lineTo(x,MAP);sCtx.stroke();}
  for(let y=0;y<=MAP;y+=200){sCtx.beginPath();sCtx.moveTo(0,y);sCtx.lineTo(MAP,y);sCtx.stroke();}
  sCtx.shadowColor='rgba(57,255,20,0.4)';sCtx.shadowBlur=10;
  sCtx.strokeStyle='rgba(57,255,20,0.55)';sCtx.lineWidth=3;sCtx.strokeRect(0,0,MAP,MAP);sCtx.shadowBlur=0;
  staticMapReady=true;
}

// Class colors
const CC={
  SCOUT:  {m:'#39ff14',g:'rgba(57,255,20,',b:'#39ff14'},
  WARRIOR:{m:'#e8e8ff',g:'rgba(200,200,255,',b:'#c8c8ff'},
  HEAVY:  {m:'#ff8c00',g:'rgba(255,140,0,', b:'#ff8c00'},
  SNIPER: {m:'#00e5ff',g:'rgba(0,229,255,', b:'#00e5ff'},
  TWIN:   {m:'#ff3aff',g:'rgba(255,58,255,',b:'#ff3aff'},
};

// ── MENU BACKGROUND ─────────────────────────────────────
let bgPts=[];
for(let i=0;i<55;i++)bgPts.push({x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-.5)*0.28,vy:(Math.random()-.5)*0.28,s:Math.random()*1.8,a:Math.random()*0.35+0.05});
function drawMenuBg(){
  bgCtx.clearRect(0,0,W,H);
  bgCtx.strokeStyle='rgba(57,255,20,0.035)';bgCtx.lineWidth=1;
  const sz=65;
  for(let col=-1;col<W/sz+2;col++){for(let row=-1;row<H/sz+2;row++){
    const ox=(row%2===0?0:sz*0.5),x=col*sz+ox,y=row*sz*0.866;
    bgCtx.beginPath();
    for(let i=0;i<6;i++){const a=Math.PI/3*i,px=x+sz*0.5*Math.cos(a),py=y+sz*0.5*Math.sin(a);i===0?bgCtx.moveTo(px,py):bgCtx.lineTo(px,py);}
    bgCtx.closePath();bgCtx.stroke();
  }}
  for(const p of bgPts){
    p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=W;if(p.x>W)p.x=0;if(p.y<0)p.y=H;if(p.y>H)p.y=0;
    bgCtx.beginPath();bgCtx.arc(p.x,p.y,p.s,0,Math.PI*2);
    bgCtx.fillStyle=`rgba(57,255,20,${p.a})`;bgCtx.fill();
  }
}

// ── PERSISTENCE ─────────────────────────────────────────
const DS='{"rp":0,"wins":0,"kills":0,"games":0,"peakRp":0,"history":[]}';
let pd=JSON.parse(localStorage.getItem('tankroyale')||DS);
if(pd.xp!==undefined&&pd.rp===undefined){pd.rp=pd.xp;pd.peakRp=pd.xp;pd.history=[];delete pd.xp;}
if(!pd.history)pd.history=[];if(!pd.peakRp)pd.peakRp=pd.rp||0;
function saveData(){localStorage.setItem('tankroyale',JSON.stringify(pd));}
const TIERS=[
  {name:'BRONZE',  minRp:0,   divs:3,rpPerDiv:100, color:'#cd7f32'},
  {name:'SILVER',  minRp:300, divs:3,rpPerDiv:150, color:'#b0b0b0'},
  {name:'GOLD',    minRp:750, divs:3,rpPerDiv:200, color:'#ffd700'},
  {name:'PLATINUM',minRp:1350,divs:3,rpPerDiv:300, color:'#40e0d0'},
  {name:'DIAMOND', minRp:2250,divs:3,rpPerDiv:400, color:'#a0d8ef'},
  {name:'MASTER',  minRp:3450,divs:1,rpPerDiv:999, color:'#ffffff'},
];
function getRankInfo(rp){
  rp=Math.max(0,rp);let ti=0;for(let i=0;i<TIERS.length;i++){if(rp>=TIERS[i].minRp)ti=i;}
  const T=TIERS[ti],rpT=rp-T.minRp;
  const div=T.divs===1?0:Math.min(T.divs-1,Math.floor(rpT/T.rpPerDiv));
  const rpD=T.divs===1?rpT:rpT-div*T.rpPerDiv;
  const dl=T.divs===1?'':' '+['III','II','I'][div];
  return{tier:T,tierIdx:ti,div,rpInDiv:rpD,label:T.name+dl,color:T.color,rpPerDiv:T.divs===1?999:T.rpPerDiv,isMaster:T.name==='MASTER',totalRp:rp};
}
function calcRpChange(place,kills){
  let base=0;
  if(place===1)base=50;else if(place<=3)base=30;else if(place<=5)base=20;else if(place<=10)base=10;else if(place<=15)base=0;else base=-15;
  const kb=Math.min(kills*8,40);const ti=getRankInfo(pd.rp).tierIdx;
  const rm=[1,1,1.1,1.2,1.3,1.5][ti]||1;
  return{total:base>=0?Math.round((base+kb)*rm):Math.round(base*rm),base,killBonus:Math.round(kb)};
}
function applyRpChange(ch){const b=pd.rp;pd.rp=Math.max(0,pd.rp+ch);if(pd.rp>(pd.peakRp||0))pd.peakRp=pd.rp;return{before:b,after:pd.rp};}

// ── CLASSES ─────────────────────────────────────────────
const CLASSES={
  SCOUT:  {icon:'◎',hp:70, speed:5.2,damage:18,fireRate:300,bulletSpeed:15,bulletLife:230,radius:15,barrels:1,ability:'DASH',  abilityDesc:'Burst forward',       abilityCooldown:4000, stats:{HP:'70',SPD:'★★★★★',DMG:'★★☆☆☆',FIRE:'★★★★☆'}},
  WARRIOR:{icon:'◉',hp:100,speed:3.6,damage:25,fireRate:400,bulletSpeed:12,bulletLife:200,radius:18,barrels:1,ability:'SHIELD',abilityDesc:'2s invincibility',    abilityCooldown:8000, stats:{HP:'100',SPD:'★★★☆☆',DMG:'★★★☆☆',FIRE:'★★★☆☆'}},
  HEAVY:  {icon:'⬟',hp:165,speed:2.4,damage:48,fireRate:720,bulletSpeed:10,bulletLife:155,radius:23,barrels:1,ability:'SLAM',  abilityDesc:'Shockwave nearby',    abilityCooldown:10000,stats:{HP:'165',SPD:'★★☆☆☆',DMG:'★★★★★',FIRE:'★★☆☆☆'}},
  SNIPER: {icon:'⊕',hp:80, speed:3.2,damage:70,fireRate:950,bulletSpeed:22,bulletLife:380,radius:16,barrels:1,ability:'CLOAK', abilityDesc:'Invisible on radar',  abilityCooldown:9000, stats:{HP:'80',SPD:'★★☆☆☆',DMG:'★★★★★',FIRE:'★★☆☆☆'}},
  TWIN:   {icon:'⊞',hp:90, speed:3.4,damage:16,fireRate:330,bulletSpeed:12,bulletLife:190,radius:17,barrels:2,ability:'BURST', abilityDesc:'6-shot rapid burst',  abilityCooldown:6000, stats:{HP:'90',SPD:'★★★☆☆',DMG:'★★★☆☆',FIRE:'★★★★☆'}},
};
const UPGRADES=[
  {id:'hp',   name:'ARMOR+',   desc:'+30 max HP  +20 current',apply:t=>{t.maxHp+=30;t.hp=Math.min(t.maxHp,t.hp+20);}},
  {id:'spd',  name:'OVERDRIVE',desc:'+15% move speed',        apply:t=>{t.speed*=1.15;}},
  {id:'dmg',  name:'WARHEAD',  desc:'+20% bullet damage',     apply:t=>{t.damage*=1.2;}},
  {id:'fire', name:'AUTOLOAD', desc:'-15% reload time',       apply:t=>{t.fireRate*=0.85;}},
  {id:'bspd', name:'HYPERBOLT',desc:'+20% bullet velocity',   apply:t=>{t.bulletSpeed*=1.2;}},
  {id:'range',name:'LONGSHOT', desc:'+30% bullet range',      apply:t=>{t.bulletLife*=1.3;}},
  {id:'regen',name:'REPAIR',   desc:'Passive HP regen',       apply:t=>{t.regen=(t.regen||0)+0.05;}},
  {id:'pierce',name:'PIERCE',  desc:'Bullets pierce 1 extra', apply:t=>{t.pierce=true;}},
  {id:'split',name:'SPLITTER', desc:'Bullets split on hit',   apply:t=>{t.split=true;}},
  {id:'cd',   name:'COOLDOWN', desc:'-20% ability cooldown',  apply:t=>{t.abilityCooldown*=0.8;}},
  {id:'multi',name:'MULTISHOT',desc:'Fire extra bullet',      apply:t=>{t.extraBarrel=true;}},
];
function xpForLevel(l){return 60+l*55;}

// ── MQTT ────────────────────────────────────────────────
const MY_ID=Math.random().toString(36).slice(2,10);
let mqttClient=null,mqttConnected=false,lobbyCode=null,lobbyPlayers={};
let isLobbyHost=false,lobbyCountdown=60,lobbyTimer=null,pendingMode=null,onlineMode=false;
function genCode(){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';return Array.from({length:4},()=>c[Math.floor(Math.random()*c.length)]).join('');}
function mqttTopic(code,sub){return`tankroyale/${code}/${sub}`;}
function initMQTT(cb){
  if(mqttClient&&mqttConnected){cb();return;}
  mqttClient=new Paho.MQTT.Client('broker.emqx.io',8084,'/mqtt','tr_'+MY_ID);
  mqttClient.onConnectionLost=()=>{mqttConnected=false;};
  mqttClient.onMessageArrived=onMQTTMessage;
  mqttClient.connect({useSSL:true,timeout:10,keepAliveInterval:30,
    onSuccess:()=>{mqttConnected=true;document.getElementById('mqttStatus').textContent='◈ CONNECTED';cb();},
    onFailure:()=>{mqttConnected=false;document.getElementById('mqttStatus').textContent='OFFLINE — BOT ONLY';}});
}
function mqttPublish(topic,payload){
  if(!mqttClient||!mqttConnected)return;
  const msg=new Paho.MQTT.Message(JSON.stringify(payload));msg.destinationName=topic;msg.retained=false;
  try{mqttClient.send(msg);}catch(e){}
}
function mqttSubscribe(topic){if(!mqttClient||!mqttConnected)return;try{mqttClient.subscribe(topic);}catch(e){}}
function onMQTTMessage(message){
  let data;try{data=JSON.parse(message.payloadString);}catch(e){return;}
  const topic=message.destinationName;
  if(topic===mqttTopic(lobbyCode,'join'))handlePlayerJoin(data);
  else if(topic===mqttTopic(lobbyCode,'leave'))handlePlayerLeave(data);
  else if(topic===mqttTopic(lobbyCode,'start'))handleGameStart(data);
  else if(topic===mqttTopic(lobbyCode,'state'))handlePlayerState(data);
  else if(topic===mqttTopic(lobbyCode,'event'))handleGameEvent(data);
}
function showOnlineOptions(){
  document.getElementById('menu').style.display='none';
  document.getElementById('onlineScreen').style.display='flex';
  document.getElementById('mqttStatus').textContent='CONNECTING...';initMQTT(()=>{});
}
function createLobby(cls){
  lobbyCode=genCode();isLobbyHost=true;lobbyPlayers={};
  lobbyPlayers[MY_ID]={id:MY_ID,name:'P_'+MY_ID.slice(0,4).toUpperCase(),className:cls,isBot:false};
  showLobbyScreen();mqttSubscribe(mqttTopic(lobbyCode,'join'));mqttSubscribe(mqttTopic(lobbyCode,'leave'));mqttSubscribe(mqttTopic(lobbyCode,'start'));
  mqttPublish(mqttTopic(lobbyCode,'join'),{id:MY_ID,name:lobbyPlayers[MY_ID].name,className:cls,isBot:false});startLobbyCountdown();
}
function doJoinLobby(){
  const code=document.getElementById('joinInput').value.trim().toUpperCase();
  if(code.length!==4){document.getElementById('joinStatus').textContent='ENTER 4-CHARACTER CODE';return;}
  if(!mqttConnected){document.getElementById('joinStatus').textContent='NOT CONNECTED';return;}
  document.getElementById('joinStatus').textContent='JOINING...';
  pendingMode='online_join_'+code;document.getElementById('onlineScreen').style.display='none';
  document.getElementById('classScreen').style.display='flex';buildClassGrid();
}
function joinLobby(code,cls){
  lobbyCode=code;isLobbyHost=false;lobbyPlayers={};
  lobbyPlayers[MY_ID]={id:MY_ID,name:'P_'+MY_ID.slice(0,4).toUpperCase(),className:cls,isBot:false};
  showLobbyScreen();mqttSubscribe(mqttTopic(lobbyCode,'join'));mqttSubscribe(mqttTopic(lobbyCode,'leave'));mqttSubscribe(mqttTopic(lobbyCode,'start'));
  mqttPublish(mqttTopic(lobbyCode,'join'),{id:MY_ID,name:lobbyPlayers[MY_ID].name,className:cls,isBot:false});
}
function handlePlayerJoin(data){
  if(data.id===MY_ID)return;lobbyPlayers[data.id]=data;
  if(isLobbyHost)mqttPublish(mqttTopic(lobbyCode,'join'),{id:MY_ID,name:lobbyPlayers[MY_ID].name,className:lobbyPlayers[MY_ID].className,isBot:false});
  updateLobbyUI();
}
function handlePlayerLeave(data){delete lobbyPlayers[data.id];updateLobbyUI();}
function handleGameStart(data){if(isLobbyHost)return;clearInterval(lobbyTimer);document.getElementById('lobbyScreen').style.display='none';startOnlineGame(data);}
function startLobbyCountdown(){
  lobbyCountdown=60;updateLobbyUI();
  lobbyTimer=setInterval(()=>{
    lobbyCountdown--;
    updateLobbyUI();
    if(lobbyCountdown<=0){
      clearInterval(lobbyTimer);
      if(isLobbyHost)launchOnlineLobby();
    }
  },1000);
}
function launchOnlineLobby(){
  const real=Object.values(lobbyPlayers).filter(p=>!p.isBot),all=[...real];
  const ck=Object.keys(CLASSES),seed=Math.floor(Math.random()*999999);
  while(all.length<MAX_P)all.push({id:'bot_'+all.length,name:'BOT_'+Math.random().toString(36).slice(2,5).toUpperCase(),className:ck[Math.floor(Math.random()*ck.length)],isBot:true});
  mqttPublish(mqttTopic(lobbyCode,'start'),{players:all,mapSeed:seed});
  mqttSubscribe(mqttTopic(lobbyCode,'state'));mqttSubscribe(mqttTopic(lobbyCode,'event'));
  document.getElementById('lobbyScreen').style.display='none';startOnlineGame({players:all,mapSeed:seed});
}
function leaveLobby(){
  if(lobbyCode){mqttPublish(mqttTopic(lobbyCode,'leave'),{id:MY_ID});if(mqttClient)try{mqttClient.unsubscribe(mqttTopic(lobbyCode,'#'));}catch(e){}}
  clearInterval(lobbyTimer);lobbyCode=null;showMenu();
}
function showLobbyScreen(){
  ['menu','classScreen','onlineScreen','deathScreen','winScreen'].forEach(id=>{document.getElementById(id).style.display='none';});
  document.getElementById('lobbyScreen').style.display='flex';
  document.getElementById('lobbyCode').textContent=lobbyCode;
  document.getElementById('lobbyCodeLabel').onclick=()=>{
    navigator.clipboard.writeText(lobbyCode).catch(()=>{});
    document.getElementById('lobbyCodeLabel').textContent='COPIED!';
    setTimeout(()=>document.getElementById('lobbyCodeLabel').textContent='LOBBY CODE — CLICK TO COPY',1500);
  };updateLobbyUI();
}
function updateLobbyUI(){
  const list=document.getElementById('playerList');
  const allPlayers=Object.values(lobbyPlayers);
  const realPlayers=allPlayers.filter(p=>!p.isBot);
  const rc=realPlayers.length;
  const bc=MAX_P-rc;

  // Build player list HTML - show ALL real players + a few bot slots
  let html='';
  for(const p of realPlayers){
    const cls=CLASSES[p.className]||CLASSES.WARRIOR;
    const isSelf=p.id===MY_ID;
    const isHost=isLobbyHost?isSelf:(p.id===Object.values(lobbyPlayers)[0]?.id);
    html+=`<div class="playerEntry${isSelf?' isSelf':''}">
      <span class="pname">
        <span class="picon">${cls.icon}</span>
        <span>${p.name}${isSelf?' <span style="color:rgba(57,255,20,0.38);font-size:8px">[YOU]</span>':''}</span>
      </span>
      <span class="pright">
        <span class="pclass">${p.className}</span>
        ${isHost?'<span class="phost">HOST</span>':''}
      </span>
    </div>`;
  }
  // Show bot slots
  const showBotSlots=Math.min(bc,Math.max(0,5-rc));
  for(let i=0;i<showBotSlots;i++)html+=`<div class="playerEntry isBot"><span class="pname"><span class="picon">⬟</span> WAITING...</span><span class="pright"><span class="pclass">BOT SLOT</span></span></div>`;
  if(bc>showBotSlots)html+=`<div class="playerEntry isBot" style="justify-content:center;color:rgba(57,255,20,0.22)">+${bc-showBotSlots} MORE BOT SLOTS</div>`;
  list.innerHTML=html;

  // Count label
  const cl=document.getElementById('lobbyCountLabel');if(cl)cl.textContent=`${rc} / ${MAX_P} PLAYERS`;

  // Countdown display
  const cd=document.getElementById('countdown');
  const fill=document.getElementById('countdownFill');
  if(cd){
    cd.textContent=lobbyCountdown;
    const urgent=lobbyCountdown<=10;
    cd.className=urgent?'urgent':'';
    if(fill){fill.style.width=((lobbyCountdown/60)*100)+'%';fill.className=urgent?'urgent':'';}
  }

  const st=document.getElementById('lobbyStatus');
  if(st)st.textContent=isLobbyHost?'◈ YOU ARE HOST — GAME LAUNCHES AT ZERO':'WAITING FOR HOST TO START...';
}

// ── ONLINE SYNC ─────────────────────────────────────────
let netStateInterval=null;
function handlePlayerState(data){
  if(data.id===MY_ID)return;const ent=entities.find(e=>e.netId===data.id);if(!ent||!ent.alive)return;
  ent._nx=data.x;ent._ny=data.y;ent.turretAngle=data.ta;ent.hp=data.hp;ent.alive=data.alive;
  if(!data.alive&&ent.alive)killTank(ent,null);
}
function handleGameEvent(data){
  if(data.type==='shoot'&&data.id!==MY_ID){const ent=entities.find(e=>e.netId===data.id);if(ent&&ent.alive){const c=CC[ent.className]||CC.WARRIOR;const a=data.angle,bx=ent.x+Math.cos(a)*(ent.radius+15),by=ent.y+Math.sin(a)*(ent.radius+15);bullets.push({x:bx,y:by,vx:Math.cos(a)*ent.bulletSpeed,vy:Math.sin(a)*ent.bulletSpeed,owner:ent,life:ent.bulletLife,r:ent.className==='HEAVY'?7:ent.className==='SNIPER'?3:4,damage:ent.damage,pierce:ent.pierce,split:ent.split,hits:0,color:c.b,glow:c.g});}}
  if(data.type==='ability'&&data.id!==MY_ID){const ent=entities.find(e=>e.netId===data.id);if(ent&&ent.alive)useAbility(ent);}
}
function broadcastState(){
  if(!onlineMode||!mqttConnected||!player||!player.alive)return;
  mqttPublish(mqttTopic(lobbyCode,'state'),{id:MY_ID,x:Math.round(player.x),y:Math.round(player.y),ta:player.turretAngle,hp:Math.round(player.hp),alive:player.alive});
}
function broadcastShoot(a){if(!onlineMode||!mqttConnected)return;mqttPublish(mqttTopic(lobbyCode,'event'),{type:'shoot',id:MY_ID,angle:a});}
function broadcastAbility(){if(!onlineMode||!mqttConnected)return;mqttPublish(mqttTopic(lobbyCode,'event'),{type:'ability',id:MY_ID});}

// ── GAME STATE ───────────────────────────────────────────
let gameMode,gameRunning=false;
let player,entities=[],bullets=[],particles=[],pickups=[];
let camera={x:0,y:0};
let mouseWorld={x:0,y:0},mouseScreen={x:W/2,y:H/2};
let keys={},mouseDown=false;
let zoneRadius,zoneCenter,zoneTargetRadius,zoneShrinkStart;
const zoneShrinkDelay=18000;
let trees=[],rocks=[],killFeedEntries=[];
let selectedClass='WARRIOR';
let gameStartTime,sessionKills=0;
let shake={x:0,y:0,t:0};

// ── MENU CROSSHAIR ───────────────────────────────────────
const menuCvs=document.getElementById('menuCvs');
const mxc=menuCvs.getContext('2d');
menuCvs.width=W;menuCvs.height=H;menuCvs.style.pointerEvents='none';
let menuMouse={x:W/2,y:H/2},menuFlash=0,menuCrsVisible=true,menuBgT=0;

function drawMenuCrosshair(){
  mxc.clearRect(0,0,W,H);
  if(!menuCrsVisible)return;
  const x=menuMouse.x,y=menuMouse.y,sz=16,gap=6,fl=menuFlash>0;
  mxc.save();
  mxc.shadowColor=fl?'rgba(57,255,20,0.9)':'rgba(57,255,20,0.45)';
  mxc.shadowBlur=fl?22:10;
  mxc.strokeStyle=fl?'rgba(57,255,20,1)':'rgba(57,255,20,0.82)';
  mxc.lineWidth=fl?2.5:1.5;
  mxc.beginPath();
  mxc.moveTo(x-sz-gap,y);mxc.lineTo(x-gap,y);mxc.moveTo(x+gap,y);mxc.lineTo(x+sz+gap,y);
  mxc.moveTo(x,y-sz-gap);mxc.lineTo(x,y-gap);mxc.moveTo(x,y+gap);mxc.lineTo(x,y+sz+gap);
  mxc.stroke();
  mxc.shadowBlur=fl?12:0;
  mxc.beginPath();mxc.arc(x,y,fl?2.5:1.5,0,Math.PI*2);mxc.fillStyle='rgba(57,255,20,0.9)';mxc.fill();
  mxc.restore();if(menuFlash>0)menuFlash--;
}
function menuLoop(){
  if(!gameRunning){menuBgT++;if(menuBgT%2===0)drawMenuBg();drawMenuCrosshair();requestAnimationFrame(menuLoop);}
}
requestAnimationFrame(menuLoop);
window.addEventListener('mousemove',e=>{
  menuMouse.x=e.clientX;menuMouse.y=e.clientY;
  if(gameRunning){mouseScreen.x=e.clientX;mouseScreen.y=e.clientY;mouseWorld.x=e.clientX+camera.x;mouseWorld.y=e.clientY+camera.y;}
});
document.addEventListener('mousedown',e=>{
  if(gameRunning)return;
  if(e.button===0&&e.target.tagName!=='BUTTON'&&e.target.tagName!=='INPUT'&&!e.target.closest('.classCard')){playShot();menuFlash=8;}
});

// ── SCREENS ──────────────────────────────────────────────
function showMenu(){
  gameRunning=false;onlineMode=false;menuCrsVisible=true;
  if(netStateInterval){clearInterval(netStateInterval);netStateInterval=null;}
  ['classScreen','onlineScreen','lobbyScreen','deathScreen','winScreen'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none';});
  document.getElementById('menu').style.display='flex';updateMenuRankCard();
  document.getElementById('statsRow').textContent=`${pd.games} GAMES · ${pd.kills} KILLS · ${pd.wins} WINS`;
  requestAnimationFrame(menuLoop);
}
function updateMenuRankCard(){
  const ri=getRankInfo(pd.rp);
  const lbl=document.getElementById('rankTierLabel');lbl.textContent=ri.label;lbl.style.color=ri.color;lbl.style.textShadow=`0 0 14px ${ri.color}`;
  document.getElementById('rankRpLabel').textContent=`${pd.rp} RP  ·  PEAK: ${pd.peakRp} RP`;
  const pct=ri.isMaster?100:Math.min(100,(ri.rpInDiv/ri.rpPerDiv)*100);
  const fill=document.getElementById('rankBarFill');fill.style.width=pct+'%';fill.style.background=ri.color;fill.style.boxShadow=`0 0 8px ${ri.color}`;
  document.getElementById('rankBarSub').textContent=ri.isMaster?`MASTER — ${pd.rp} RP TOTAL`:`${ri.rpInDiv} / ${ri.rpPerDiv} RP TO NEXT DIVISION`;
}
function renderRpResult(elId,place,kills,won){
  const el=document.getElementById(elId);if(!el)return;
  const rp=calcRpChange(place,kills);const res=applyRpChange(rp.total);
  pd.games++;pd.kills+=kills;if(won)pd.wins++;saveData();
  const ra=getRankInfo(res.after),rb2=getRankInfo(res.before);
  const prom=ra.label!==rb2.label&&res.after>res.before,dem=ra.label!==rb2.label&&res.after<res.before;
  const sign=rp.total>=0?'+':'';
  const pct=ra.isMaster?100:Math.min(100,(ra.rpInDiv/ra.rpPerDiv)*100);
  el.innerHTML=`<div class="rpTitle">RANKED RESULT</div><div class="rpRows">PLACEMENT: #${place} &nbsp;·&nbsp; KILLS: ${kills}<br>BASE: ${rp.base>=0?'+':''}${rp.base} RP &nbsp; KILLS: +${rp.killBonus} RP</div><div class="rpChange ${rp.total>=0?'up':'down'}">${sign}${rp.total} RP</div>${prom?`<div style="color:#39ff14;font-size:11px;letter-spacing:3px;margin-top:6px;text-shadow:0 0 10px #39ff14">▲ PROMOTED TO ${ra.label}!</div>`:''}${dem?`<div style="color:#ff3a3a;font-size:11px;letter-spacing:3px;margin-top:6px;">▼ DEMOTED TO ${ra.label}</div>`:''}<div class="rpNew" style="color:${ra.color};text-shadow:0 0 8px ${ra.color}">${ra.label} — ${res.after} RP</div><div class="rpBarWrap"><div class="rpBarFill" id="rpAnimBar" style="width:0%;background:${ra.color};box-shadow:0 0 8px ${ra.color}"></div></div>`;
  setTimeout(()=>{const b=document.getElementById('rpAnimBar');if(b)b.style.width=pct+'%';},100);
}
function showClassSelect(mode){
  pendingMode=mode;
  ['menu','onlineScreen','lobbyScreen'].forEach(id=>{const e=document.getElementById(id);if(e)e.style.display='none';});
  document.getElementById('classScreen').style.display='flex';buildClassGrid();
}
function goBackFromClass(){
  document.getElementById('classScreen').style.display='none';
  if(pendingMode&&pendingMode.startsWith('online'))document.getElementById('onlineScreen').style.display='flex';else showMenu();
}
function confirmClass(){
  document.getElementById('classScreen').style.display='none';
  if(pendingMode==='bot')startGame('bot',selectedClass);
  else if(pendingMode==='online_create'){if(!mqttConnected){startGame('bot',selectedClass);return;}createLobby(selectedClass);}
  else if(pendingMode&&pendingMode.startsWith('online_join_')){const code=pendingMode.split('_')[2];if(!mqttConnected){showMenu();return;}joinLobby(code,selectedClass);}
}
function quickRestart(){
  document.getElementById('deathScreen').style.display='none';document.getElementById('winScreen').style.display='none';
  if(onlineMode)showMenu();else startGame(gameMode,selectedClass);
}
function buildClassGrid(){
  const grid=document.getElementById('classGrid');grid.innerHTML='';
  for(const[key,cls]of Object.entries(CLASSES)){
    const col=CC[key]||CC.WARRIOR;
    const div=document.createElement('div');div.className='classCard'+(key===selectedClass?' selected':'');
    div.innerHTML=`<div class="cicon" style="color:${col.m};filter:drop-shadow(0 0 8px ${col.m})">${cls.icon}</div><div class="cname" style="color:${col.m};text-shadow:0 0 8px ${col.m}">${key}</div><div class="cstat">${Object.entries(cls.stats).map(([k,v])=>`${k}: ${v}`).join('<br>')}</div><div class="cbadge">▶ ${cls.ability}: ${cls.abilityDesc}</div>`;
    div.onclick=()=>{selectedClass=key;document.querySelectorAll('.classCard').forEach(c=>c.classList.remove('selected'));div.classList.add('selected');};
    grid.appendChild(div);
  }
}

// ── GAME INIT ────────────────────────────────────────────
function seededRand(seed){let s=seed;return()=>{s=(s*16807)%2147483647;return(s-1)/2147483646;};}
function generateMap(seed=0){
  const rand=seededRand(seed||Math.floor(Math.random()*999999));trees=[];rocks=[];
  for(let i=0;i<240;i++)trees.push({x:rand()*MAP,y:rand()*MAP,r:8+rand()*16,v:Math.floor(rand()*3)});
  for(let i=0;i<100;i++)rocks.push({x:rand()*MAP,y:rand()*MAP,w:20+rand()*40,h:16+rand()*30});
}
function spawnPos(){
  let x,y,t=0;do{x=300+Math.random()*(MAP-600);y=300+Math.random()*(MAP-600);t++;}
  while(t<30&&entities.some(e=>dist(e.x,e.y,x,y)<200));return{x,y};
}
function dist(x1,y1,x2,y2){return Math.sqrt((x2-x1)**2+(y2-y1)**2);}
function createTank(x,y,isPlayer,id,clsName,netId){
  const cls=CLASSES[clsName]||CLASSES.WARRIOR;
  return{x,y,id,netId:netId||null,angle:0,turretAngle:0,hp:cls.hp,maxHp:cls.hp,speed:cls.speed,damage:cls.damage,fireRate:cls.fireRate,bulletSpeed:cls.bulletSpeed,bulletLife:cls.bulletLife,radius:cls.radius,barrels:cls.barrels,className:clsName,classIcon:cls.icon,ability:cls.ability,abilityCooldown:cls.abilityCooldown,abilityLastUsed:0,regen:0,pierce:false,split:false,extraBarrel:false,isPlayer,isBot:!isPlayer,isRemote:false,alive:true,vx:0,vy:0,lastShot:0,kills:0,xp:0,level:1,xpToNext:xpForLevel(1),upgrades:[],aiState:'wander',aiTarget:null,aiMoveAngle:Math.random()*Math.PI*2,aiMoveTimer:0,name:isPlayer?'YOU':'BOT_'+Math.random().toString(36).slice(2,6).toUpperCase(),cloaked:false,shielded:false,_nx:null,_ny:null,hitFlash:0};
}
function startGame(mode,cls){
  gameMode=mode;gameRunning=true;onlineMode=false;menuCrsVisible=false;
  entities=[];bullets=[];particles=[];pickups=[];killFeedEntries=[];sessionKills=0;
  zoneRadius=MAP*0.5;zoneTargetRadius=zoneRadius*0.55;zoneCenter={x:MAP/2,y:MAP/2};zoneShrinkStart=Date.now()+zoneShrinkDelay;
  gameStartTime=Date.now();generateMap();buildStaticMap();
  const pos=spawnPos();player=createTank(pos.x,pos.y,true,0,cls,MY_ID);entities.push(player);
  const ck=Object.keys(CLASSES);for(let i=1;i<MAX_P;i++){const p=spawnPos();entities.push(createTank(p.x,p.y,false,i,ck[Math.floor(Math.random()*ck.length)]));}
  camera.x=player.x-W/2;camera.y=player.y-H/2;document.getElementById('upgradePanel').style.display='none';updateHUD();
  requestAnimationFrame(gameLoop);
}
function startOnlineGame(data){
  gameMode='online';gameRunning=true;onlineMode=true;menuCrsVisible=false;
  entities=[];bullets=[];particles=[];pickups=[];killFeedEntries=[];sessionKills=0;
  zoneRadius=MAP*0.5;zoneTargetRadius=zoneRadius*0.55;zoneCenter={x:MAP/2,y:MAP/2};zoneShrinkStart=Date.now()+zoneShrinkDelay;
  gameStartTime=Date.now();generateMap(data.mapSeed);buildStaticMap();
  data.players.forEach((p,i)=>{const pos=spawnPos(),isMe=p.id===MY_ID;const tank=createTank(pos.x,pos.y,isMe,i,p.className,p.id);tank.name=isMe?'YOU':p.name;tank.isBot=p.isBot;tank.isRemote=!isMe&&!p.isBot;if(isMe)player=tank;entities.push(tank);});
  camera.x=player.x-W/2;camera.y=player.y-H/2;document.getElementById('upgradePanel').style.display='none';
  mqttSubscribe(mqttTopic(lobbyCode,'state'));mqttSubscribe(mqttTopic(lobbyCode,'event'));
  netStateInterval=setInterval(broadcastState,50);updateHUD();requestAnimationFrame(gameLoop);
}

// ── UPGRADES ─────────────────────────────────────────────
function offerUpgrades(){
  gameRunning=false;const panel=document.getElementById('upgradePanel');panel.style.display='block';
  const btns=document.getElementById('upgradeBtns');btns.innerHTML='';
  const pool=[...UPGRADES].filter(u=>!(u.id==='pierce'&&player.pierce)&&!(u.id==='split'&&player.split)&&!(u.id==='multi'&&player.extraBarrel));
  const choices=[];while(choices.length<3&&pool.length>0)choices.push(pool.splice(Math.floor(Math.random()*pool.length),1)[0]);
  choices.forEach(u=>{
    const btn=document.createElement('button');btn.className='upBtn';
    const times=player.upgrades.filter(x=>x===u.id).length;
    btn.innerHTML=`<div class="upName">${u.name}</div><div class="upDesc">${u.desc}</div><div class="upLvl">Taken: ${times}×</div>`;
    btn.onclick=()=>{u.apply(player);player.upgrades.push(u.id);showXPFloat(`▲ ${u.name}`,player);panel.style.display='none';gameRunning=true;requestAnimationFrame(gameLoop);};
    btns.appendChild(btn);
  });
}
function giveXP(tank,amount){
  if(!tank.isPlayer)return;tank.xp+=amount;
  while(tank.xp>=tank.xpToNext){tank.xp-=tank.xpToNext;tank.level++;tank.xpToNext=xpForLevel(tank.level);offerUpgrades();return;}
  updateHUD();
}
function showXPFloat(txt,tank){
  const sx=tank.x-camera.x,sy=tank.y-camera.y-30;
  const div=document.createElement('div');div.className='xpFloat';div.textContent=txt;div.style.left=sx+'px';div.style.top=sy+'px';
  document.getElementById('gc').appendChild(div);setTimeout(()=>div.remove(),950);
}

// ── FIRING ───────────────────────────────────────────────
function fireBullet(tank){
  const now=Date.now();if(now-tank.lastShot<tank.fireRate)return false;
  tank.lastShot=now;if(tank.isPlayer)playShot(tank.className==='HEAVY'?0.58:tank.className==='SNIPER'?1.6:1);
  let angles=[tank.turretAngle];
  if(tank.barrels===2)angles=[tank.turretAngle-0.1,tank.turretAngle+0.1];
  if(tank.extraBarrel)angles.push(tank.turretAngle+Math.PI/8*(Math.random()>.5?1:-1));
  const col=CC[tank.className]||CC.WARRIOR;
  for(const a of angles){
    const bx=tank.x+Math.cos(a)*(tank.radius+15),by=tank.y+Math.sin(a)*(tank.radius+15);
    bullets.push({x:bx,y:by,vx:Math.cos(a)*tank.bulletSpeed,vy:Math.sin(a)*tank.bulletSpeed,owner:tank,life:tank.bulletLife,r:tank.className==='HEAVY'?7:tank.className==='SNIPER'?3:4,damage:tank.damage,pierce:tank.pierce,split:tank.split,hits:0,color:col.b,glow:col.g});
    for(let i=0;i<(tank.isPlayer?7:3);i++)particles.push({x:bx,y:by,vx:(Math.random()-.5)*5+Math.cos(a)*4,vy:(Math.random()-.5)*5+Math.sin(a)*4,life:10,maxLife:10,r:4+Math.random()*4,color:col.b,glow:col.g});
  }
  if(tank.isPlayer&&tank.className==='HEAVY')shake={x:(Math.random()-.5)*8,y:(Math.random()-.5)*8,t:6};
  return true;
}
function fireSplit(b){
  for(let i=0;i<3;i++){const a=Math.atan2(b.vy,b.vx)+(i-1)*0.45,sp=Math.hypot(b.vx,b.vy)*0.7;bullets.push({x:b.x,y:b.y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,owner:b.owner,life:70,r:3,damage:b.damage*0.5,pierce:false,split:false,hits:0,color:b.color,glow:b.glow});}
}

// ── ABILITY ──────────────────────────────────────────────
function useAbility(tank){
  const now=Date.now();if(now-tank.abilityLastUsed<tank.abilityCooldown)return;
  tank.abilityLastUsed=now;if(tank.isPlayer&&onlineMode)broadcastAbility();
  const col=CC[tank.className]||CC.WARRIOR;
  if(tank.ability==='DASH'){const sp=tank.speed*8;tank.x=Math.max(tank.radius,Math.min(MAP-tank.radius,tank.x+Math.cos(tank.angle)*sp));tank.y=Math.max(tank.radius,Math.min(MAP-tank.radius,tank.y+Math.sin(tank.angle)*sp));for(let i=0;i<18;i++)particles.push({x:tank.x,y:tank.y,vx:(Math.random()-.5)*9,vy:(Math.random()-.5)*9,life:20,maxLife:20,r:5+Math.random()*5,color:col.b,glow:col.g});}
  if(tank.ability==='SHIELD'){tank.shielded=true;setTimeout(()=>{tank.shielded=false;},2000);}
  if(tank.ability==='SLAM'){for(const e of entities){if(e===tank||!e.alive)continue;const d=dist(tank.x,tank.y,e.x,e.y);if(d<190){e.hp-=tank.damage*1.6;spawnExp(e.x,e.y,10,col.b,col.g);if(e.hp<=0)killTank(e,tank);}}for(let i=0;i<32;i++){const a=Math.random()*Math.PI*2;particles.push({x:tank.x,y:tank.y,vx:Math.cos(a)*8,vy:Math.sin(a)*8,life:30,maxLife:30,r:5+Math.random()*6,color:col.b,glow:col.g});}if(tank.isPlayer)shake={x:(Math.random()-.5)*14,y:(Math.random()-.5)*14,t:10};}
  if(tank.ability==='CLOAK'){tank.cloaked=true;setTimeout(()=>{tank.cloaked=false;},3500);}
  if(tank.ability==='BURST'){for(let i=0;i<6;i++)setTimeout(()=>{if(tank.alive){tank.lastShot=0;fireBullet(tank);tank.lastShot=Date.now();}},i*55);}
}

// ── AI ───────────────────────────────────────────────────
function updateAI(tank,dt){
  if(!tank.alive)return;let nearest=null,nd=Infinity;
  for(const e of entities){if(e===tank||!e.alive)continue;const d=dist(tank.x,tank.y,e.x,e.y);if(d<nd){nd=d;nearest=e;}}
  const dz=dist(tank.x,tank.y,zoneCenter.x,zoneCenter.y);
  if(dz>zoneRadius-80){tank.aiMoveAngle=Math.atan2(zoneCenter.y-tank.y,zoneCenter.x-tank.x);tank.aiState='wander';}
  else if(nearest&&nd<680){tank.aiState='chase';tank.aiTarget=nearest;}
  else{tank.aiState='wander';tank.aiMoveTimer-=dt;if(tank.aiMoveTimer<=0){tank.aiMoveTimer=1800+Math.random()*3000;tank.aiMoveAngle=Math.random()*Math.PI*2;}}
  if(tank.aiState==='chase'&&tank.aiTarget){const ang=Math.atan2(tank.aiTarget.y-tank.y,tank.aiTarget.x-tank.x);tank.aiMoveAngle=ang;tank.turretAngle=ang;if(nd<580)fireBullet(tank);if(Math.random()<0.003)useAbility(tank);}
  else tank.turretAngle=tank.aiMoveAngle;
  tank.angle=tank.aiMoveAngle;tank.vx=Math.cos(tank.aiMoveAngle)*tank.speed*0.7;tank.vy=Math.sin(tank.aiMoveAngle)*tank.speed*0.7;
}
function updatePlayer(){
  if(!player||!player.alive)return;let dx=0,dy=0;
  if(keys['w']||keys['arrowup'])dy--;if(keys['s']||keys['arrowdown'])dy++;
  if(keys['a']||keys['arrowleft'])dx--;if(keys['d']||keys['arrowright'])dx++;
  if(dx||dy){const l=Math.hypot(dx,dy);player.angle=Math.atan2(dy/l,dx/l);player.vx=(dx/l)*player.speed;player.vy=(dy/l)*player.speed;}else{player.vx=0;player.vy=0;}
  player.turretAngle=Math.atan2(mouseWorld.y-player.y,mouseWorld.x-player.x);
}

// ── PICKUPS ──────────────────────────────────────────────
function spawnPickup(x,y){if(Math.random()>0.45)return;pickups.push({x,y,type:'hp',value:30,r:10,pulse:0});}
function updatePickups(){
  for(let i=pickups.length-1;i>=0;i--){const pk=pickups[i];pk.pulse+=0.07;if(dist(pk.x,pk.y,player.x,player.y)<pk.r+player.radius){player.hp=Math.min(player.maxHp,player.hp+pk.value);showXPFloat('+'+pk.value+' HP',player);pickups.splice(i,1);}}
}

// ── KILL / WIN ───────────────────────────────────────────
function killTank(tank,killer){
  if(!tank.alive)return;tank.alive=false;
  const col=CC[tank.className]||CC.WARRIOR;
  const np=tank.isPlayer?28:14;
  spawnExp(tank.x,tank.y,np,col.b,col.g);spawnExp(tank.x,tank.y,Math.round(np/2),'#ffb800','rgba(255,184,0,');
  spawnPickup(tank.x,tank.y);
  const kn=killer?(killer.isPlayer?'YOU':killer.name):'ZONE';
  addKF(`${kn} ▶ ${tank.name}`,killer&&killer.isPlayer);
  if(killer&&killer.isPlayer){killer.kills++;const xg=50+tank.level*15;giveXP(killer,xg);showXPFloat(`+${xg} XP`,killer);sessionKills++;}
  if(tank.isPlayer){
    menuCrsVisible=true;if(netStateInterval){clearInterval(netStateInterval);netStateInterval=null;}
    const alv=entities.filter(e=>e.alive).length,place=alv+1,elapsed=Math.floor((Date.now()-gameStartTime)/1000);
    setTimeout(()=>{document.getElementById('endStats').innerHTML=`#${place} / ${MAX_P} &nbsp;·&nbsp; ${elapsed}s &nbsp;·&nbsp; ${sessionKills} KILLS<br><span style="color:rgba(57,255,20,0.3)">${player.className} LV${player.level}</span>`;renderRpResult('rpResult',place,sessionKills,false);document.getElementById('deathScreen').style.display='flex';},1000);
    gameRunning=false;requestAnimationFrame(menuLoop);return;
  }
  const alive=entities.filter(e=>e.alive);
  if(alive.length===1&&alive[0].isPlayer){
    menuCrsVisible=true;if(netStateInterval){clearInterval(netStateInterval);netStateInterval=null;}
    const elapsed=Math.floor((Date.now()-gameStartTime)/1000);
    setTimeout(()=>{document.getElementById('endStats2').innerHTML=`#1 / ${MAX_P} &nbsp;·&nbsp; ${elapsed}s &nbsp;·&nbsp; ${sessionKills} KILLS<br><span style="color:rgba(57,255,20,0.3)">${player.className} LV${player.level}</span>`;renderRpResult('rpResult2',1,sessionKills,true);document.getElementById('winScreen').style.display='flex';},500);
    gameRunning=false;requestAnimationFrame(menuLoop);
  }
}
function spawnExp(x,y,n=20,color='#ffffff',glow='rgba(255,255,255,'){
  // Cap total particles for performance
  const cap=300;if(particles.length>cap)particles.splice(0,particles.length-cap+n);
  for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,sp=1+Math.random()*6;particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:25+Math.random()*30,maxLife:55,r:3+Math.random()*7,color,glow});}
}
function addKF(msg,isKill=false){const d=document.createElement('div');d.className='ke'+(isKill?' kp':'');d.textContent=msg;document.getElementById('kf').prepend(d);killFeedEntries.push(d);setTimeout(()=>{d.style.opacity='0';setTimeout(()=>d.remove(),900);},3500);if(killFeedEntries.length>6)killFeedEntries.shift().remove();}

// ── HUD ──────────────────────────────────────────────────
function updateHUD(){
  if(!player)return;
  const hp=Math.max(0,player.hp/player.maxHp);
  document.getElementById('hpFill').style.width=(hp*100)+'%';
  const hc=hp>0.5?'#39ff14':hp>0.25?'#ffb800':'#ff3a3a';
  document.getElementById('hpFill').style.background=hc;document.getElementById('hpFill').style.boxShadow=`0 0 8px ${hc}`;
  document.getElementById('xpFill').style.width=(player.xp/player.xpToNext*100)+'%';
  document.getElementById('lvlLabel').textContent='LV '+player.level;
  const col=CC[player.className]||CC.WARRIOR;
  document.getElementById('classTag').innerHTML=`<span style="color:${col.m};text-shadow:0 0 8px ${col.m}">${player.className} ${player.classIcon}</span>${onlineMode?' <span style="color:rgba(57,255,20,0.28)">[ONLINE]</span>':''}`;
  document.getElementById('aliveCount').textContent='◈ '+entities.filter(e=>e.alive).length+' ALIVE';
  const ri=getRankInfo(pd.rp);const rb=document.getElementById('rankBadge');rb.textContent=ri.label+' · '+pd.rp+' RP';rb.style.color=ri.color;
  const now=Date.now(),cdL=Math.max(0,player.abilityCooldown-(now-player.abilityLastUsed)),cdP=1-cdL/player.abilityCooldown,pips=10,fill=Math.round(cdP*pips);
  const pc=cdL===0?col.m:'rgba(57,255,20,0.75)';
  document.getElementById('ammoBar').innerHTML=`<span style="font-size:8px;letter-spacing:2px;color:rgba(57,255,20,0.28);margin-right:6px;">${player.ability}</span>`+Array.from({length:pips},(_,i)=>`<div class="ammoPip${i<fill?'':' empty'}" style="${i<fill?`background:${pc};box-shadow:0 0 5px ${pc}`:''}"></div>`).join('');
  document.getElementById('zoneInfo').textContent=Date.now()>zoneShrinkStart?'⚠ STORM CLOSING':'';
}

// ── GAME LOOP ─────────────────────────────────────────────
let lastFrame=0,frameCount=0;
function gameLoop(ts){if(!gameRunning)return;const dt=Math.min(ts-lastFrame,50);lastFrame=ts;frameCount++;update(dt);render();requestAnimationFrame(gameLoop);}
function update(dt){
  updatePlayer();const now=Date.now();
  if(now>zoneShrinkStart){zoneRadius+=(zoneTargetRadius-zoneRadius)*0.0015;if(Math.abs(zoneRadius-zoneTargetRadius)<5){zoneShrinkStart=now+zoneShrinkDelay;zoneTargetRadius=Math.max(80,zoneRadius*0.62);}}
  for(const tank of entities){
    if(!tank.alive)continue;
    if(tank.isRemote){if(tank._nx!==null){tank.x+=(tank._nx-tank.x)*0.25;tank.y+=(tank._ny-tank.y)*0.25;}continue;}
    if(!tank.isPlayer)updateAI(tank,dt);
    if(tank.regen&&tank.hp<tank.maxHp)tank.hp=Math.min(tank.maxHp,tank.hp+tank.regen);
    tank.x=Math.max(tank.radius,Math.min(MAP-tank.radius,tank.x+tank.vx));
    tank.y=Math.max(tank.radius,Math.min(MAP-tank.radius,tank.y+tank.vy));
    if(tank.hitFlash>0)tank.hitFlash--;
    const dz=dist(tank.x,tank.y,zoneCenter.x,zoneCenter.y);if(dz>zoneRadius){tank.hp-=0.18;if(tank.hp<=0)killTank(tank,null);}
  }
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];b.x+=b.vx;b.y+=b.vy;b.life--;
    if(b.x<0||b.x>MAP||b.y<0||b.y>MAP||b.life<=0){bullets.splice(i,1);continue;}
    let gone=false;
    for(const r of rocks){if(b.x>r.x&&b.x<r.x+r.w&&b.y>r.y&&b.y<r.y+r.h){spawnExp(b.x,b.y,5,b.color,b.glow);bullets.splice(i,1);gone=true;break;}}
    if(gone)continue;
    for(const tank of entities){
      if(!tank.alive||tank===b.owner||tank.shielded||tank.isRemote)continue;
      if(dist(b.x,b.y,tank.x,tank.y)<tank.radius){
        tank.hp-=b.damage;tank.hitFlash=4;spawnExp(b.x,b.y,6,b.color,b.glow);
        if(b.split&&b.hits===0)fireSplit(b);b.hits++;if(!b.pierce||b.hits>1){bullets.splice(i,1);gone=true;}
        if(tank.hp<=0)killTank(tank,b.owner);break;
      }
    }if(gone)continue;
  }
  for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.x+=p.vx;p.y+=p.vy;p.vx*=0.88;p.vy*=0.88;p.life--;if(p.life<=0)particles.splice(i,1);}
  updatePickups();
  if(shake.t>0){shake.t--;if(shake.t===0){shake.x=0;shake.y=0;}else{shake.x*=0.75;shake.y*=0.75;}}
  camera.x+=(player.x-W/2-camera.x)*0.1;camera.y+=(player.y-H/2-camera.y)*0.1;
  if(frameCount%3===0)updateHUD();
}

// ── RENDER ────────────────────────────────────────────────
function render(){
  ctx.clearRect(0,0,W,H);ctx.save();
  ctx.translate(Math.round(shake.x),Math.round(shake.y));ctx.translate(-camera.x,-camera.y);

  // Draw static map elements from offscreen canvas
  if(staticMapReady){
    ctx.drawImage(staticCanvas,0,0);
  } else {
    ctx.fillStyle='#07100a';ctx.fillRect(0,0,MAP,MAP);
  }

  // Zone darkness
  ctx.save();ctx.fillStyle='rgba(0,0,0,0.52)';ctx.beginPath();ctx.rect(0,0,MAP,MAP);ctx.arc(zoneCenter.x,zoneCenter.y,zoneRadius,0,Math.PI*2,true);ctx.fill();ctx.restore();
  const za=0.3+Math.sin(Date.now()*0.003)*0.14;
  ctx.beginPath();ctx.arc(zoneCenter.x,zoneCenter.y,zoneRadius,0,Math.PI*2);ctx.shadowColor='rgba(255,58,58,0.4)';ctx.shadowBlur=8;ctx.strokeStyle=`rgba(255,58,58,${za})`;ctx.lineWidth=2.5;ctx.stroke();ctx.shadowBlur=0;

  // Trees
  for(const t of trees){
    ctx.beginPath();ctx.ellipse(t.x+4,t.y+5,t.r*1.1,t.r*0.65,0.3,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,0.28)';ctx.fill();
    ctx.beginPath();ctx.arc(t.x,t.y,t.r,0,Math.PI*2);
    ctx.fillStyle=['#0f2010','#112612','#0e1e0e'][t.v||0];ctx.fill();
    ctx.strokeStyle='rgba(57,255,20,0.07)';ctx.lineWidth=1;ctx.stroke();
    ctx.beginPath();ctx.arc(t.x,t.y,t.r*0.5,0,Math.PI*2);ctx.fillStyle='rgba(57,255,20,0.055)';ctx.fill();
  }

  // Rocks
  for(const r of rocks){
    ctx.save();ctx.translate(r.x+r.w/2,r.y+r.h/2);
    ctx.fillStyle='rgba(0,0,0,0.3)';ctx.fillRect(3,4,r.w,r.h);
    const rg=ctx.createLinearGradient(-r.w/2,-r.h/2,r.w/2,r.h/2);rg.addColorStop(0,'#1e2318');rg.addColorStop(1,'#121510');
    ctx.fillStyle=rg;ctx.fillRect(-r.w/2,-r.h/2,r.w,r.h);
    ctx.strokeStyle='rgba(57,255,20,0.09)';ctx.lineWidth=1;ctx.strokeRect(-r.w/2,-r.h/2,r.w,r.h);ctx.restore();
  }

  // Pickups
  for(const pk of pickups){
    const s=1+Math.sin(pk.pulse)*0.14,al=0.7+Math.sin(pk.pulse)*0.28;
    ctx.save();ctx.translate(pk.x,pk.y);ctx.scale(s,s);
    ctx.shadowColor=`rgba(57,255,20,${al*0.55})`;ctx.shadowBlur=12;
    ctx.strokeStyle=`rgba(57,255,20,${al})`;ctx.lineWidth=1.5;ctx.strokeRect(-pk.r,-pk.r,pk.r*2,pk.r*2);
    ctx.fillStyle=`rgba(57,255,20,0.07)`;ctx.fillRect(-pk.r,-pk.r,pk.r*2,pk.r*2);
    ctx.strokeStyle=`rgba(57,255,20,${al})`;ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(0,-pk.r*0.5);ctx.lineTo(0,pk.r*0.5);ctx.moveTo(-pk.r*0.5,0);ctx.lineTo(pk.r*0.5,0);ctx.stroke();
    ctx.shadowBlur=0;ctx.restore();
  }

  // Particles
  for(const p of particles){
    const a=p.life/p.maxLife;ctx.beginPath();ctx.arc(p.x,p.y,p.r*a,0,Math.PI*2);
    ctx.shadowColor=p.glow?`${p.glow}${a*0.7})`:'rgba(255,255,255,0.3)';ctx.shadowBlur=p.r*2;
    ctx.fillStyle=p.color||'#fff';ctx.globalAlpha=a;ctx.fill();ctx.globalAlpha=1;ctx.shadowBlur=0;
  }

  // Bullets
  for(const b of bullets){
    const bc=b.color||'#fff',bg=b.glow||'rgba(255,255,255,';
    ctx.beginPath();ctx.moveTo(b.x,b.y);ctx.lineTo(b.x-b.vx*7,b.y-b.vy*7);
    ctx.strokeStyle=`${bg}0.18)`;ctx.lineWidth=b.r*1.3;ctx.shadowColor=`${bg}0.28)`;ctx.shadowBlur=6;ctx.stroke();
    ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.shadowColor=`${bg}0.75)`;ctx.shadowBlur=b.r*3;ctx.fillStyle=bc;ctx.fill();ctx.shadowBlur=0;
  }

  // Tanks
  for(const tank of entities){if(!tank.alive||(tank.cloaked&&!tank.isPlayer))continue;drawTank(ctx,tank);}
  ctx.restore();
  drawCrosshair();renderMinimap();
}

function drawTank(c,tank){
  c.save();c.translate(tank.x,tank.y);const r=tank.radius;
  const col=CC[tank.className]||CC.WARRIOR;const isEnemy=!tank.isPlayer&&!tank.isRemote;
  c.globalAlpha=tank.cloaked?0.22:1;

  // Shadow
  c.beginPath();c.ellipse(4,5,r,r*0.65,0,0,Math.PI*2);c.fillStyle='rgba(0,0,0,0.42)';c.fill();

  // Shield
  if(tank.shielded){const sp=Date.now()*0.004;c.beginPath();c.arc(0,0,r+10,0,Math.PI*2);c.strokeStyle=`rgba(255,255,255,${0.38+Math.sin(sp)*0.18})`;c.lineWidth=2.5;c.shadowColor='rgba(255,255,255,0.5)';c.shadowBlur=14;c.stroke();c.shadowBlur=0;}

  // Treads
  c.save();c.rotate(tank.angle);
  c.fillStyle=isEnemy?'#181815':'#131310';
  c.fillRect(-r,-r-4,r*2,5);c.fillRect(-r,r-1,r*2,5);
  c.strokeStyle=isEnemy?'rgba(255,255,255,0.05)':`${col.g}0.1)`;c.lineWidth=1;
  for(let ti=-r+3;ti<r;ti+=6){c.beginPath();c.moveTo(ti,-r-4);c.lineTo(ti,-r+1);c.stroke();c.beginPath();c.moveTo(ti,r-1);c.lineTo(ti,r+4);c.stroke();}
  c.restore();

  // Hull
  const hullColor=tank.hitFlash>0?'#ffffff':(tank.isPlayer?col.m:isEnemy?'#7a7a72':'#b0b0a8');
  c.beginPath();c.arc(0,0,r,0,Math.PI*2);c.fillStyle=hullColor;
  if(!isEnemy){c.shadowColor=col.m;c.shadowBlur=tank.isPlayer?14:6;}
  c.fill();c.strokeStyle='rgba(0,0,0,0.65)';c.lineWidth=2;c.stroke();c.shadowBlur=0;

  // Hull detail
  if(tank.isPlayer){c.strokeStyle='rgba(0,0,0,0.25)';c.lineWidth=1;c.beginPath();c.arc(0,0,r*0.68,0,Math.PI*2);c.stroke();}

  // Barrel
  c.save();c.rotate(tank.turretAngle);
  const blen=tank.className==='SNIPER'?r+26:tank.className==='HEAVY'?r+13:r+15;
  const bw=tank.className==='HEAVY'?10:tank.className==='SNIPER'?4:7;
  c.fillStyle=tank.isPlayer?col.m:(isEnemy?'#5a5a52':'#909088');
  if(!isEnemy){c.shadowColor=col.m;c.shadowBlur=5;}
  if(tank.barrels===2){c.fillRect(0,-bw*0.85,blen,bw*0.65);c.fillRect(0,bw*0.2,blen,bw*0.65);c.fillStyle='rgba(255,255,255,0.12)';c.fillRect(blen-3,-bw*0.85,3,bw*0.65);c.fillRect(blen-3,bw*0.2,3,bw*0.65);}
  else{c.fillRect(0,-bw/2,blen,bw);c.fillStyle='rgba(255,255,255,0.1)';c.fillRect(blen-3,-bw/2,3,bw);}
  c.shadowBlur=0;
  c.beginPath();c.arc(0,0,r*0.5,0,Math.PI*2);c.fillStyle=isEnemy?'rgba(0,0,0,0.55)':`${col.g}0.45)`;c.fill();
  c.restore();

  // Icon
  c.font=`bold ${Math.round(r*0.72)}px Arial`;c.fillStyle=isEnemy?'rgba(255,255,255,0.55)':'rgba(0,0,0,0.82)';c.textAlign='center';c.textBaseline='middle';c.fillText(tank.classIcon,0,0);

  // HP bar
  if(tank.isPlayer||tank.hp<tank.maxHp){
    const bw2=r*2.6,bh=4,bx=-r*1.3,by=-r-13;
    c.fillStyle='rgba(0,0,0,0.6)';c.fillRect(bx-1,by-1,bw2+2,bh+2);c.fillStyle='rgba(255,255,255,0.06)';c.fillRect(bx,by,bw2,bh);
    const pct=Math.max(0,tank.hp/tank.maxHp),hc=pct>0.5?col.m:pct>0.25?'#ffb800':'#ff3a3a';
    c.fillStyle=hc;c.shadowColor=hc;c.shadowBlur=4;c.fillRect(bx,by,bw2*pct,bh);c.shadowBlur=0;
  }

  // Name
  if(tank.isRemote){c.font='9px Share Tech Mono,monospace';c.fillStyle='rgba(0,229,255,0.65)';c.textAlign='center';c.fillText(tank.name,0,-r-22);}
  else if(tank.level>1){c.font='8px Share Tech Mono,monospace';c.fillStyle=tank.isPlayer?`${col.g}0.55)`:'rgba(255,255,255,0.3)';c.textAlign='center';c.fillText('LV'+tank.level,0,-r-22);}

  c.globalAlpha=1;c.restore();
}

function drawCrosshair(){
  const x=mouseScreen.x,y=mouseScreen.y,sz=14,gap=5;
  ctx.save();ctx.shadowColor='rgba(57,255,20,0.45)';ctx.shadowBlur=8;
  ctx.strokeStyle='rgba(57,255,20,0.88)';ctx.lineWidth=1.5;
  ctx.beginPath();ctx.moveTo(x-sz-gap,y);ctx.lineTo(x-gap,y);ctx.moveTo(x+gap,y);ctx.lineTo(x+sz+gap,y);ctx.moveTo(x,y-sz-gap);ctx.lineTo(x,y-gap);ctx.moveTo(x,y+gap);ctx.lineTo(x,y+sz+gap);ctx.stroke();
  ctx.beginPath();ctx.arc(x,y,1.5,0,Math.PI*2);ctx.fillStyle='rgba(57,255,20,0.9)';ctx.fill();ctx.shadowBlur=0;
  if(player&&player.alive){
    const now=Date.now(),cdL=Math.max(0,player.abilityCooldown-(now-player.abilityLastUsed)),pct=1-cdL/player.abilityCooldown;
    const col=CC[player.className]||CC.WARRIOR;
    ctx.beginPath();ctx.arc(x,y,24,-Math.PI/2,-Math.PI/2+pct*Math.PI*2);
    ctx.strokeStyle=cdL===0?col.m:`${col.g}0.32)`;ctx.shadowColor=cdL===0?col.m:'transparent';ctx.shadowBlur=cdL===0?8:0;ctx.lineWidth=2;ctx.stroke();ctx.shadowBlur=0;
  }
  ctx.restore();
}

function renderMinimap(){
  const sc=MINI/MAP;mctx.clearRect(0,0,MINI,MINI);
  mctx.fillStyle='rgba(2,7,2,0.96)';mctx.fillRect(0,0,MINI,MINI);
  mctx.strokeStyle='rgba(57,255,20,0.055)';mctx.lineWidth=0.5;
  for(let i=0;i<=MINI;i+=MINI/8){mctx.beginPath();mctx.moveTo(i,0);mctx.lineTo(i,MINI);mctx.stroke();mctx.beginPath();mctx.moveTo(0,i);mctx.lineTo(MINI,i);mctx.stroke();}
  mctx.beginPath();mctx.arc(zoneCenter.x*sc,zoneCenter.y*sc,zoneRadius*sc,0,Math.PI*2);mctx.strokeStyle='rgba(255,58,58,0.45)';mctx.lineWidth=1;mctx.stroke();
  mctx.strokeStyle='rgba(57,255,20,0.18)';mctx.lineWidth=0.5;mctx.strokeRect(camera.x*sc,camera.y*sc,W*sc,H*sc);
  for(const tank of entities){
    if(!tank.alive||(tank.cloaked&&!tank.isPlayer))continue;
    const col=CC[tank.className]||CC.WARRIOR;const dr=tank.isPlayer?4:2.5;
    mctx.beginPath();mctx.arc(tank.x*sc,tank.y*sc,dr,0,Math.PI*2);
    mctx.fillStyle=tank.isPlayer?col.m:tank.isRemote?'#00e5ff':'rgba(255,255,255,0.32)';
    if(tank.isPlayer){mctx.shadowColor=col.m;mctx.shadowBlur=6;}
    mctx.fill();mctx.shadowBlur=0;
  }
  mctx.strokeStyle='rgba(57,255,20,0.28)';mctx.lineWidth=1;mctx.strokeRect(0,0,MINI,MINI);
  mctx.font='6px Share Tech Mono,monospace';mctx.fillStyle='rgba(57,255,20,0.22)';mctx.textAlign='center';mctx.fillText('N',MINI/2,8);
}

// ── INPUT ─────────────────────────────────────────────────
window.addEventListener('keydown',e=>{
  keys[e.key.toLowerCase()]=true;
  if((e.key==='1'||e.key===' ')&&player&&player.alive&&gameRunning){e.preventDefault();useAbility(player);}
});
window.addEventListener('keyup',e=>{keys[e.key.toLowerCase()]=false;});
canvas.addEventListener('mousemove',e=>{mouseScreen.x=e.clientX;mouseScreen.y=e.clientY;mouseWorld.x=e.clientX+camera.x;mouseWorld.y=e.clientY+camera.y;});
canvas.addEventListener('mousedown',e=>{if(e.button===0){mouseDown=true;if(player&&player.alive&&gameRunning){const f=fireBullet(player);if(f&&onlineMode)broadcastShoot(player.turretAngle);}}});
canvas.addEventListener('mouseup',e=>{if(e.button===0)mouseDown=false;});
setInterval(()=>{if(mouseDown&&player&&player.alive&&gameRunning){const f=fireBullet(player);if(f&&onlineMode)broadcastShoot(player.turretAngle);}},75);

showMenu();
</script>
</body>
</html>